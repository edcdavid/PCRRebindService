apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: 99-disk-encryption-master
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
      - contents:
          source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKREVCVUc9dHJ1ZQpSRVNFUlZFRF9TTE9UPTMxCgojIGNyZWF0ZSBhIHRlbXBvcmFyeSBrZXkgaW4gdGhlIHJlc2VydmVkIHNsb3QgdG8gZGlzYWJsZSBQQ1IgcHJvdGVjdGlvbgphZGRSZXNlcnZlZFNsb3QoKSB7CiAgICBBTllQQVNTPSIxMjM0NTY3ODkwIgogICAgZWNobyAtZSAiJEFOWVBBU1NcbiIgfCBjbGV2aXMgbHVrcyBiaW5kIC1zICRSRVNFUlZFRF9TTE9UIC1kIC9kZXYvZGlzay9ieS1wYXJ0bGFiZWwvcm9vdCB0cG0yICd7fScKfQoKI3NldCAteAoKIyBsb2cgZnVuY3Rpb24uIFRha2VzIDIgYXJndW1lbnRzOgojIGxvZyBsZXZlbDogZGVidWcgb3IgaW5mbwojIHN0cmluZyB0byBwcmludApsb2coKSB7CiAgICBjYXNlICQxIGluCiAgICAiZGVidWciKQogICAgICAgIGVjaG8gIkRFQlVHIC0gJDIiCiAgICAgICAgOzsKICAgICJpbmZvIikKICAgICAgICBlY2hvICJJTkZPIC0gJDIiCiAgICAgICAgOzsKICAgICopCiAgICAgICAgIyBDb2RlIHRvIGV4ZWN1dGUgd2hlbiBubyBwYXR0ZXJucyBtYXRjaAogICAgICAgIDs7CiAgICBlc2FjCn0KCiMgbG9ncyBhIHN0cmluZyB3aXRoIGEgZGVidWcgbGV2ZWwKbG9nRGVidWcoKSB7CiAgICBpZiAhIFsgLXYgREVCVUcgXSB8fCAoWyAtdiBERUJVRyBdICYmIFsgIiRERUJVRyIgPT0gInRydWUiIF0pOyB0aGVuCiAgICAgICAgbG9nICJkZWJ1ZyIgIiQxIgogICAgZmkKfQoKIyBsb2dzIGEgc3RyaW5nIHdpdGggYSBpbmZvIGxldmVsCmxvZ0luZm8oKSB7CiAgICBsb2cgImluZm8iICIkMSIKfQoKU1BPS0VfS1VCRUNPTkZJR19QQVRIPS92YXIvbGliL2t1YmVsZXQva3ViZWNvbmZpZwpIVUJfU0VDUkVUX05BTUVTUEFDRT1vcGVuLWNsdXN0ZXItbWFuYWdlbWVudC1hZ2VudApIVUJfU0VDUkVUX05BTUU9aHViLWt1YmVjb25maWctc2VjcmV0CgojIHJldHJpZXZlcyB0aGUga3ViZWNvbmZpZyBmb3IgdGhpcyBzcG9rZSdzIGNsdXN0ZXIKZ2V0SHViS3ViZWNvbmZpZygpIHsKICAgIEtVQkVDT05GSUdfREFUQT0kKG9jIC0ta3ViZWNvbmZpZyAkMSBnZXQgc2VjcmV0IC1uICQyICQzIC1vIGpzb24gfCBqcSAuZGF0YS5rdWJlY29uZmlnIHwgc2VkICdzLyIvL2cnIHwgYmFzZTY0IC1kKQogICAgaWYgWyAteiAiJEtVQkVDT05GSUdfREFUQSIgXTsgdGhlbgogICAgICAgIHJldHVybiAxCiAgICBmaQogICAgVExTX0tFWT0kKG9jIC0ta3ViZWNvbmZpZyAkMSBnZXQgc2VjcmV0IC1uICQyICQzIC1vIGpzb24gfCBqcSAnLmRhdGEuInRscy5rZXkiJyB8IHNlZCAncy8iLy9nJykKICAgIFRMU19DUlQ9JChvYyAtLWt1YmVjb25maWcgJDEgZ2V0IHNlY3JldCAtbiAkMiAkMyAtbyBqc29uIHwganEgJy5kYXRhLiJ0bHMuY3J0IicgfCBzZWQgJ3MvIi8vZycpCiAgICBlY2hvICIkS1VCRUNPTkZJR19EQVRBIiB8IHNlZCAtZSAicy9jbGllbnQtY2VydGlmaWNhdGU6IHRscy5jcnQvY2xpZW50LWNlcnRpZmljYXRlLWRhdGE6ICRUTFNfQ1JUL2ciIHwgc2VkIC1lICJzL2NsaWVudC1rZXk6IHRscy5rZXkvY2xpZW50LWtleS1kYXRhOiAkVExTX0tFWS9nIiA+L3RtcC9rdWJlY29uZmlnLWh1YgogICAgcmV0dXJuIDAKfQoKIyBSZXRyZWl2ZXMgVEFMTSdzIHN0YXRlIGluIHRoZSBodWIgY2x1c3RlcidzIG1hbmFnZWRDbHVzdGVyIG9iamVjdC4gVGFrZXMgb25lIGFyZ3VtZW50OgojIGRvbmUgLT4gcmV0dXJuIHRydWUgaWYgdGhlIHp0cC1kb25lIGxhYmVsIGlzIHNldCwgZmFsc2Ugb3RoZXJ3aXNlCiMgcnVubmluZyAtPiByZXR1cm4gdHJ1ZSBpZiB0aGUgenRwLXJ1bm5pbmcgbGFiZWwgaXMgc2V0LCBmYWxzZSBvdGhlcndpc2UKaXNadHBTdGF0ZSgpIHsKICAgIFJFU1VMVD1mYWxzZQogICAgY2FzZSAkMSBpbgogICAgInJ1bm5pbmciKQogICAgICAgIFJFU1VMVD0kKEtVQkVDT05GSUc9L3RtcC9rdWJlY29uZmlnLWh1YiBvYyBnZXQgbWFuYWdlZGNsdXN0ZXIgc25vMiAtb2pzb24gfCBqcSAnLm1ldGFkYXRhLmxhYmVsc1sienRwLXJ1bm5pbmciXSE9bnVsbCcpCiAgICAgICAgOzsKICAgICJkb25lIikKICAgICAgICBSRVNVTFQ9JChLVUJFQ09ORklHPS90bXAva3ViZWNvbmZpZy1odWIgb2MgZ2V0IG1hbmFnZWRjbHVzdGVyIHNubzIgLW9qc29uIHwganEgJy5tZXRhZGF0YS5sYWJlbHNbInp0cC1kb25lIl0hPW51bGwnKQogICAgICAgIDs7CiAgICAqKQogICAgICAgICMgQ29kZSB0byBleGVjdXRlIHdoZW4gbm8gcGF0dGVybnMgbWF0Y2gKICAgICAgICA7OwogICAgZXNhYwogICAgaWYgWyAiJFJFU1VMVCIgPT0gImZhbHNlIiBdOyB0aGVuCiAgICAgICAgbG9nRGVidWcgIlRBTE0gJDEgc3RhdGUgaXMgJFJFU1VMVCIKICAgICAgICByZXR1cm4gMQogICAgZmkKICAgIGxvZ0RlYnVnICJUQUxNICQxIHN0YXRlIGlzICRSRVNVTFQiCiAgICByZXR1cm4gMAp9Cgpsb2dJbmZvICJTaHV0dGluZyBkb3duIG9yIHJlYm9vdGluZyIKaWYgISBnZXRIdWJLdWJlY29uZmlnICRTUE9LRV9LVUJFQ09ORklHX1BBVEggJEhVQl9TRUNSRVRfTkFNRVNQQUNFICRIVUJfU0VDUkVUX05BTUU7IHRoZW4KICAgIGxvZ0luZm8gImh1YiBrdWJlY29uZmlnIGlzIG5vIHJlYWR5IHlldCBhdCAkU1BPS0VfS1VCRUNPTkZJR19QQVRIIHBhdGgsIGNhbm5vdCBnZXQgc3Bva2Ugc2VjcmV0ICRIVUJfU0VDUkVUX05BTUUgaW4gJEhVQl9TRUNSRVRfTkFNRVNQQUNFIG5hbWVzcGFjZSIKICAgIGV4aXQgMQpmaQppZiBpc1p0cFN0YXRlICJydW5uaW5nIjsgdGhlbgogICAgbG9nSW5mbyAiVEFMTSBzdGF0ZSBpcyBydW5uaW5nLCBkaXNhYmxpbmcgUENSIHByb3RlY3Rpb24iCiAgICBhZGRSZXNlcnZlZFNsb3QKICAgIGNsZXZpcyBsdWtzIGxpc3QgLWQgL2Rldi9kaXNrL2J5LXBhcnRsYWJlbC9yb290CiAgICBleGl0IDAKZmkKCmxvZ0luZm8gIlRBTE0gc3RhdGUgaXMgbm90IHJ1bm5pbmcgKGFzc3VtaW5nIGRvbmUpLCBjb250aW51ZSB3aXRoIFBDUiBwcm90ZWN0aW9uIgo=
        mode: 493
        path: /usr/local/bin/disablePcrOnRebootOrShutdown.sh
      - contents:
          source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKREVCVUc9dHJ1ZQpDTEVWSVNfQ09ORklHX1JPT1Q9J3sidCI6MSwicGlucyI6eyJ0cG0yIjpbeyJoYXNoIjoic2hhMjU2Iiwia2V5IjoiZWNjIiwicGNyX2JhbmsiOiJzaGEyNTYiLCJwY3JfaWRzIjoiMSw3In1dfX0nCgpSRVNFUlZFRF9TTE9UPTMxClJPT1RfU0xPVD0xCkNMRVZJU19DT05GSUdfUkVTRVJWRURfU0xPVD0iJFJFU0VSVkVEX1NMT1Q6IHRwbTIgJ3tcImhhc2hcIjpcInNoYTI1NlwiLFwia2V5XCI6XCJlY2NcIn0nIgpDTEVWSVNfQ09ORklHX1JPT1RfU0xPVD0iJFJPT1RfU0xPVDogc3NzICckQ0xFVklTX0NPTkZJR19ST09UJyIKCiMgcmV0dXJuIHRydWUgaWQgdGhlIHRlbXBvcmFyeSByZXNlcnZlZCBzbG90IGlzIGNvbmZpZ3VyZWQgd2l0aCBhIGtleSAodG8gZGlzYWJsZSBQQ1IgcHJvdGVjdGlvbiksIHJldHVybnMgZmFsc2Ugb3RoZXJ3aXNlCmlzUmVzZXJ2ZWRTbG90UHJlc2VudCgpIHsKICAgIFJFU1VMVD0kKGNsZXZpcyBsdWtzIGxpc3QgLWQgL2Rldi9kaXNrL2J5LXBhcnRsYWJlbC9yb290IC1zICRSRVNFUlZFRF9TTE9UKQogICAgaWYgWyAtbiAiJFJFU1VMVCIgXSAmJiBbICIkUkVTVUxUIiA9PSAiJENMRVZJU19DT05GSUdfUkVTRVJWRURfU0xPVCIgXTsgdGhlbgogICAgICAgIGxvZ0RlYnVnICJyZXNlcnZlZCBzbG90ICRSRVNFUlZFRF9TTE9UIGlzIHByZXNlbnQiCiAgICAgICAgcmV0dXJuIDAKICAgIGZpCiAgICBsb2dEZWJ1ZyAicmVzZXJ2ZWQgc2xvdCAkUkVTRVJWRURfU0xPVCBpcyBub3QgcHJlc2VudCIKICAgIHJldHVybiAxCn0KCiMgcmVtb3ZlIHRoZSB0ZW1wb3Jhcnkga2V5IGluIHRoZSByZXNlcnZlZCBzbG90IHRvIGVuYWJsZSBQQ1IgcHJvdGVjdGlvbgpyZW1vdmVSZXNlcnZlZFNsb3QoKSB7CiAgICBjbGV2aXMgbHVrcyB1bmJpbmQgLXMgJFJFU0VSVkVEX1NMT1QgLWQgL2Rldi9kaXNrL2J5LXBhcnRsYWJlbC9yb290IC1mCn0KCiMgcmViaW5kIHRoZSByb290IGRpc2sgd2l0aCBQQ1IgMSBhbmQgNyBwcm90ZWN0aW9uCnJlYmluZFdpdGhQY3IoKSB7CiAgICBjbGV2aXMtbHVrcy1lZGl0IC1kIC9kZXYvZGlzay9ieS1wYXJ0bGFiZWwvcm9vdCAtcyAkUk9PVF9TTE9UIC1jICIkQ0xFVklTX0NPTkZJR19ST09UIgp9CgojIHJldHVybiB0cnVlIGlmIHRoZSByb290IGRpc2sgaXMgYm91bmQgd2l0aCBQQ1IsIGZhbHNlIG90aGVyd2lzZQppc1Jvb3RCb3VuZFRvUGNyKCkgewogICAgUkVTVUxUPSQoY2xldmlzIGx1a3MgbGlzdCAtZCAvZGV2L2Rpc2svYnktcGFydGxhYmVsL3Jvb3QgLXMgJFJPT1RfU0xPVCkKICAgIGlmIFsgIiRSRVNVTFQiID09ICIkQ0xFVklTX0NPTkZJR19ST09UX1NMT1QiIF07IHRoZW4KICAgICAgICBsb2dEZWJ1ZyAicm9vdCBkaXNrIGlzIGVuY3J5cHRlZCBhbmQgYm91bmQgd2l0aCBUUE12MiBQQ1IiCiAgICAgICAgcmV0dXJuIDAKICAgIGZpCiAgICBsb2dEZWJ1ZyAicm9vdCBkaXNrIGlzIG5vdCBib3VuZCB3aXRoIFRQTXYyIFBDUiIKICAgIHJldHVybiAxCn0KCiMgbG9nIGZ1bmN0aW9uLiBUYWtlcyAyIGFyZ3VtZW50czoKIyBsb2cgbGV2ZWw6IGRlYnVnIG9yIGluZm8KIyBzdHJpbmcgdG8gcHJpbnQKbG9nKCkgewogICAgY2FzZSAkMSBpbgogICAgImRlYnVnIikKICAgICAgICBlY2hvICJERUJVRyAtICQyIgogICAgICAgIDs7CiAgICAiaW5mbyIpCiAgICAgICAgZWNobyAiSU5GTyAtICQyIgogICAgICAgIDs7CiAgICAqKQogICAgICAgICMgQ29kZSB0byBleGVjdXRlIHdoZW4gbm8gcGF0dGVybnMgbWF0Y2gKICAgICAgICA7OwogICAgZXNhYwp9CgojIGxvZ3MgYSBzdHJpbmcgd2l0aCBhIGRlYnVnIGxldmVsCmxvZ0RlYnVnKCkgewogICAgaWYgISBbIC12IERFQlVHIF0gfHwgKFsgLXYgREVCVUcgXSAmJiBbICIkREVCVUciID09ICJ0cnVlIiBdKTsgdGhlbgogICAgICAgIGxvZyAiZGVidWciICIkMSIKICAgIGZpCn0KCiMgbG9ncyBhIHN0cmluZyB3aXRoIGEgaW5mbyBsZXZlbApsb2dJbmZvKCkgewogICAgbG9nICJpbmZvIiAiJDEiCn0KCmxvZ0luZm8gImJvb3RpbmcgY2hlY2tpbmcgaWYgcmViaW5kaW5nIGRpc2sgbmVlZGVkIgpjbGV2aXMgbHVrcyBsaXN0IC1kIC9kZXYvZGlzay9ieS1wYXJ0bGFiZWwvcm9vdCAtcyAkUkVTRVJWRURfU0xPVAppZiBpc1Jlc2VydmVkU2xvdFByZXNlbnQ7IHRoZW4KICAgIGxvZ0luZm8gInJlc2VydmVkIHNsb3QgJFJFU0VSVkVEX1NMT1QgZGV0ZWN0ZWQsIHJlbW92aW5nIGFuZCByZWJpbmRpbmcgcm9vdCBkaXNrIgogICAgcmVtb3ZlUmVzZXJ2ZWRTbG90CiAgICByZWJpbmRXaXRoUGNyCiAgICBleGl0IDAKZmkKCmlmICEgaXNSb290Qm91bmRUb1BjcjsgdGhlbgogICAgbG9nSW5mbyAiUENSIGNvbmZpZ3VyYXRpb24gbWlzc2luZyBpbiBjbGV2aXMsIHJlYmluZGluZyB3aXRoIFBDUiIKICAgIHJlYmluZFdpdGhQY3IKICAgIGV4aXQgMApmaQoKbG9nSW5mbyAiUENSIGNvbmZpZ3VyYXRpb24gYWxyZWFkeSBwcmVzZW50IGFuZCByZXNlcnZlZCBzbG90IG5vdCBwcmVzZW50LCBjb250aW51ZSBib290Igo=
        mode: 493
        path: /usr/local/bin/rebindDiskOnBoot.sh
    systemd:
      units:
      - contents: |
          [Unit]
          After=cryptsetup.target
          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/rebindDiskOnBoot.sh
          [Install]
          WantedBy=multi-user.target
        enabled: true
        name: pcr-rebind-boot.service
      - contents: |
          [Unit]
          DefaultDependencies=no
          [Service]
          Type=simple
          ExecStart=/usr/local/bin/disablePcrOnRebootOrShutdown.sh
          [Install]
          WantedBy=shutdown.target reboot.target halt.target
        enabled: true
        name: pcr-disable-shutdown.service
