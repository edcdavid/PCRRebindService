---
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  name: 99-disk-encryption-rebind
  labels:
    machineconfiguration.openshift.io/role: master
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
      - contents:
          source: "data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKREVCVUc9dHJ1ZQpSRVNFUlZFRF9TTE9UPTMxClJPT1RfU0xPVD0xCgpTUE9LRV9LVUJFQ09ORklHX1BBVEg9L3Zhci9saWIva3ViZWxldC9rdWJlY29uZmlnCkhVQl9TRUNSRVRfTkFNRVNQQUNFPW9wZW4tY2x1c3Rlci1tYW5hZ2VtZW50LWFnZW50CkhVQl9TRUNSRVRfTkFNRT1odWIta3ViZWNvbmZpZy1zZWNyZXQKCiMgcmV0cmlldmVzIHRoZSBrdWJlY29uZmlnIGZvciB0aGlzIHNwb2tlJ3MgY2x1c3RlcgpnZXRIdWJLdWJlY29uZmlnKCkgewogICAgS1VCRUNPTkZJR19EQVRBPSQob2MgLS1rdWJlY29uZmlnICQxIGdldCBzZWNyZXQgLW4gJDIgJDMgLW8ganNvbiB8IGpxIC5kYXRhLmt1YmVjb25maWcgfCBzZWQgJ3MvIi8vZycgfCBiYXNlNjQgLWQpCiAgICBpZiBbIC16ICIkS1VCRUNPTkZJR19EQVRBIiBdOyB0aGVuCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCiAgICBUTFNfS0VZPSQob2MgLS1rdWJlY29uZmlnICQxIGdldCBzZWNyZXQgLW4gJDIgJDMgLW8ganNvbiB8IGpxICcuZGF0YS4idGxzLmtleSInIHwgc2VkICdzLyIvL2cnKQogICAgVExTX0NSVD0kKG9jIC0ta3ViZWNvbmZpZyAkMSBnZXQgc2VjcmV0IC1uICQyICQzIC1vIGpzb24gfCBqcSAnLmRhdGEuInRscy5jcnQiJyB8IHNlZCAncy8iLy9nJykKICAgIGVjaG8gIiRLVUJFQ09ORklHX0RBVEEiIHwgc2VkIC1lICJzL2NsaWVudC1jZXJ0aWZpY2F0ZTogdGxzLmNydC9jbGllbnQtY2VydGlmaWNhdGUtZGF0YTogJFRMU19DUlQvZyIgfCBzZWQgLWUgInMvY2xpZW50LWtleTogdGxzLmtleS9jbGllbnQta2V5LWRhdGE6ICRUTFNfS0VZL2ciID4vdG1wL2t1YmVjb25maWctaHViCiAgICByZXR1cm4gMAp9CgojIFJldHJlaXZlcyBUQUxNJ3Mgc3RhdGUgaW4gdGhlIGh1YiBjbHVzdGVyJ3MgbWFuYWdlZENsdXN0ZXIgb2JqZWN0LiBUYWtlcyBvbmUgYXJndW1lbnQ6CiMgZG9uZSAtPiByZXR1cm4gdHJ1ZSBpZiB0aGUgenRwLWRvbmUgbGFiZWwgaXMgc2V0LCBmYWxzZSBvdGhlcndpc2UKIyBydW5uaW5nIC0+IHJldHVybiB0cnVlIGlmIHRoZSB6dHAtcnVubmluZyBsYWJlbCBpcyBzZXQsIGZhbHNlIG90aGVyd2lzZQppc1p0cFN0YXRlKCkgewogICAgUkVTVUxUPWZhbHNlCiAgICBjYXNlICQxIGluCiAgICAicnVubmluZyIpCiAgICAgICAgUkVTVUxUPSQoS1VCRUNPTkZJRz0vdG1wL2t1YmVjb25maWctaHViIG9jIGdldCBtYW5hZ2VkY2x1c3RlciBzbm8yIC1vanNvbiB8IGpxICcubWV0YWRhdGEubGFiZWxzWyJ6dHAtcnVubmluZyJdIT1udWxsJykKICAgICAgICA7OwogICAgImRvbmUiKQogICAgICAgIFJFU1VMVD0kKEtVQkVDT05GSUc9L3RtcC9rdWJlY29uZmlnLWh1YiBvYyBnZXQgbWFuYWdlZGNsdXN0ZXIgc25vMiAtb2pzb24gfCBqcSAnLm1ldGFkYXRhLmxhYmVsc1sienRwLWRvbmUiXSE9bnVsbCcpCiAgICAgICAgOzsKICAgICopCiAgICAgICAgIyBDb2RlIHRvIGV4ZWN1dGUgd2hlbiBubyBwYXR0ZXJucyBtYXRjaAogICAgICAgIDs7CiAgICBlc2FjCiAgICBpZiBbICIkUkVTVUxUIiA9PSAiZmFsc2UiIF07IHRoZW4KICAgICAgICBsb2dEZWJ1ZyAiVEFMTSAkMSBzdGF0ZSBpcyAkUkVTVUxUIgogICAgICAgIHJldHVybiAxCiAgICBmaQogICAgbG9nRGVidWcgIlRBTE0gJDEgc3RhdGUgaXMgJFJFU1VMVCIKICAgIHJldHVybiAwCn0KCiMgcmV0dXJuIHRydWUgaWQgdGhlIHRlbXBvcmFyeSByZXNlcnZlZCBzbG90IGlzIGNvbmZpZ3VyZWQgd2l0aCBhIGtleSAodG8gZGlzYWJsZSBQQ1IgcHJvdGVjdGlvbiksIHJldHVybnMgZmFsc2Ugb3RoZXJ3aXNlCmlzUmVzZXJ2ZWRTbG90UHJlc2VudCgpIHsKICAgIFJFU1VMVD0kKGNsZXZpcyBsdWtzIGxpc3QgLWQgL2Rldi9kaXNrL2J5LXBhcnRsYWJlbC9yb290IC1zICRSRVNFUlZFRF9TTE9UKQogICAgaWYgWyAiJFJFU1VMVCIgPT0gIjMxOiB0cG0yICd7XCJoYXNoXCI6XCJzaGEyNTZcIixcImtleVwiOlwiZWNjXCJ9JyIgXTsgdGhlbgogICAgICAgIGxvZ0RlYnVnICJyZXNlcnZlZCBzbG90ICRSRVNFUlZFRF9TTE9UIGlzIHByZXNlbnQiCiAgICAgICAgcmV0dXJuIDAKICAgIGZpCiAgICBsb2dEZWJ1ZyAicmVzZXJ2ZWQgc2xvdCAkUkVTRVJWRURfU0xPVCBpcyBub3QgcHJlc2VudCIKICAgIHJldHVybiAxCn0KCiMgY3JlYXRlIGEgdGVtcG9yYXJ5IGtleSBpbiB0aGUgcmVzZXJ2ZWQgc2xvdCB0byBkaXNhYmxlIFBDUiBwcm90ZWN0aW9uCmFkZFJlc2VydmVkU2xvdCgpIHsKICAgIEFOWVBBU1M9IjEyMzQ1Njc4OTAiCiAgICBlY2hvIC1lICIkQU5ZUEFTU1xuIiB8IGNsZXZpcyBsdWtzIGJpbmQgLXMgJFJFU0VSVkVEX1NMT1QgLWQgL2Rldi9kaXNrL2J5LXBhcnRsYWJlbC9yb290IHRwbTIgJ3t9Jwp9CgojIHJlbW92ZSB0aGUgdGVtcG9yYXJ5IGtleSBpbiB0aGUgcmVzZXJ2ZWQgc2xvdCB0byBlbmFibGUgUENSIHByb3RlY3Rpb24KcmVtb3ZlUmVzZXJ2ZWRTbG90KCkgewogICAgY2xldmlzIGx1a3MgdW5iaW5kIC1zICRSRVNFUlZFRF9TTE9UIC1kIC9kZXYvZGlzay9ieS1wYXJ0bGFiZWwvcm9vdCAtZgp9CgojIHJlYmluZCB0aGUgcm9vdCBkaXNrIHdpdGggUENSIDEgYW5kIDcgcHJvdGVjdGlvbgpyZWJpbmRXaXRoUGNyMUFuZDcoKSB7CiAgICBjbGV2aXMtbHVrcy1lZGl0IC1kIC9kZXYvZGlzay9ieS1wYXJ0bGFiZWwvcm9vdCAtcyAkUk9PVF9TTE9UIC1jICd7InQiOjEsInBpbnMiOnsidHBtMiI6W3siaGFzaCI6InNoYTI1NiIsImtleSI6ImVjYyIsInBjcl9iYW5rIjoic2hhMjU2IiwicGNyX2lkcyI6IjEsNyJ9XX19Jwp9CgojIHJldHVybiB0cnVlIGlmIHRoZSByb290IGRpc2sgaXMgYm91bmQgd2l0aCBQQ1IgMSBhbmQgNyBwcm90ZWN0aW9uLCBmYWxzZSBvdGhlcndpc2UKaXNSb290Qm91bmRUb1BjcjFBbmQ3KCkgewogICAgUkVTVUxUPSQoY2xldmlzIGx1a3MgbGlzdCAtZCAvZGV2L2Rpc2svYnktcGFydGxhYmVsL3Jvb3QgLXMgJFJPT1RfU0xPVCkKICAgIGlmIFsgIiRSRVNVTFQiID09ICIxOiBzc3MgJ3tcInRcIjoxLFwicGluc1wiOntcInRwbTJcIjpbe1wiaGFzaFwiOlwic2hhMjU2XCIsXCJrZXlcIjpcImVjY1wiLFwicGNyX2JhbmtcIjpcInNoYTI1NlwiLFwicGNyX2lkc1wiOlwiMSw3XCJ9XX19JyIgXTsgdGhlbgogICAgICAgIGxvZ0RlYnVnICJyb290IGRpc2sgaXMgZW5jcnlwdGVkIGFuZCBib3VuZCB3aXRoIFRQTXYyIFBDUiAxIGFuZCA3IgogICAgICAgIHJldHVybiAwCiAgICBmaQogICAgbG9nRGVidWcgInJvb3QgZGlzayBpcyBub3QgYm91bmQgd2l0aCBUUE12MiBQQ1IgMSBhbmQgNyBwcm9wZXJseSIKICAgIHJldHVybiAxCn0KCiMgbG9nIGZ1bmN0aW9uLiBUYWtlcyAyIGFyZ3VtZW50czoKIyBsb2cgbGV2ZWw6IGRlYnVnIG9yIGluZm8KIyBzdHJpbmcgdG8gcHJpbnQKbG9nKCkgewogICAgY2FzZSAkMSBpbgogICAgImRlYnVnIikKICAgICAgICBlY2hvICJERUJVRyAtICQyIgogICAgICAgIDs7CiAgICAiaW5mbyIpCiAgICAgICAgZWNobyAiSU5GTyAtICQyIgogICAgICAgIDs7CiAgICAqKQogICAgICAgICMgQ29kZSB0byBleGVjdXRlIHdoZW4gbm8gcGF0dGVybnMgbWF0Y2gKICAgICAgICA7OwogICAgZXNhYwp9CgojIGxvZ3MgYSBzdHJpbmcgd2l0aCBhIGRlYnVnIGxldmVsCmxvZ0RlYnVnKCkgewogICAgaWYgISBbIC12IERFQlVHIF0gfHwgKFsgLXYgREVCVUcgXSAmJiBbICIkREVCVUciID09ICJ0cnVlIiBdKTsgdGhlbgogICAgICAgIGxvZyAiZGVidWciICIkMSIKICAgIGZpCn0KCiMgbG9ncyBhIHN0cmluZyB3aXRoIGEgaW5mbyBsZXZlbApsb2dJbmZvKCkgewogICAgbG9nICJpbmZvIiAiJDEiCn0KCiMgbG9ncyBhIHN0YXRlIHRyYW5zaXRpb24gYmV0d2VlbiAyIHN0YXRlcyBvbmx5IHdoZW4gc3RhdGUgY2hhbmdlcwpsb2dTdGF0ZSgpIHsKICAgIGlmIFsgIiQxIiAhPSAiJDIiIF07IHRoZW4KICAgICAgICBsb2dJbmZvICJlbnRlcmluZyAkMiBTVEFURSIKICAgIGZpCn0KCkNVUlJFTlRfU1RBVEU9IklOSVQiClBSRVZJT1VTX1NUQVRFPSJOSUwiCgpsb2dTdGF0ZSAkUFJFVklPVVNfU1RBVEUgJENVUlJFTlRfU1RBVEUKUFJFVklPVVNfU1RBVEU9JENVUlJFTlRfU1RBVEUKCndoaWxlIFsgdHJ1ZSBdOyBkbwoKICAgIHNsZWVwIDUKCiAgICBjYXNlICRDVVJSRU5UX1NUQVRFIGluCiAgICAiSU5JVCIpCiAgICAgICAgbG9nU3RhdGUgJFBSRVZJT1VTX1NUQVRFICRDVVJSRU5UX1NUQVRFCiAgICAgICAgUFJFVklPVVNfU1RBVEU9JENVUlJFTlRfU1RBVEUKICAgICAgICBpZiAhIGdldEh1Ykt1YmVjb25maWcgJFNQT0tFX0tVQkVDT05GSUdfUEFUSCAkSFVCX1NFQ1JFVF9OQU1FU1BBQ0UgJEhVQl9TRUNSRVRfTkFNRTsgdGhlbgogICAgICAgICAgICBsb2dJbmZvICJodWIga3ViZWNvbmZpZyBpcyBubyByZWFkeSB5ZXQgYXQgJFNQT0tFX0tVQkVDT05GSUdfUEFUSCBwYXRoLCBjYW5ub3QgZ2V0IHNwb2tlIHNlY3JldCAkSFVCX1NFQ1JFVF9OQU1FIGluICRIVUJfU0VDUkVUX05BTUVTUEFDRSBuYW1lc3BhY2UiCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgZmkKICAgICAgICBDVVJSRU5UX1NUQVRFPSJLVUJFQ09ORklHX1JFQURZIgogICAgICAgIDs7CiAgICAiS1VCRUNPTkZJR19SRUFEWSIpCiAgICAgICAgbG9nU3RhdGUgJFBSRVZJT1VTX1NUQVRFICRDVVJSRU5UX1NUQVRFCiAgICAgICAgUFJFVklPVVNfU1RBVEU9JENVUlJFTlRfU1RBVEUKICAgICAgICBpZiBpc1Jvb3RCb3VuZFRvUGNyMUFuZDcgJiYgISBpc1Jlc2VydmVkU2xvdFByZXNlbnQ7IHRoZW4KICAgICAgICAgICAgQ1VSUkVOVF9TVEFURT0iUENSX1BST1RFQ1RFRCIKICAgICAgICBlbHNlCiAgICAgICAgICAgIENVUlJFTlRfU1RBVEU9IlBDUl9VTlBST1RFQ1RFRCIKICAgICAgICBmaQogICAgICAgIDs7CiAgICAiUENSX1BST1RFQ1RFRCIpCiAgICAgICAgbG9nU3RhdGUgJFBSRVZJT1VTX1NUQVRFICRDVVJSRU5UX1NUQVRFCiAgICAgICAgUFJFVklPVVNfU1RBVEU9JENVUlJFTlRfU1RBVEUKICAgICAgICBpZiBpc1p0cFN0YXRlICJydW5uaW5nIjsgdGhlbgogICAgICAgICAgICBhZGRSZXNlcnZlZFNsb3QKICAgICAgICAgICAgQ1VSUkVOVF9TVEFURT0iUENSX1VOUFJPVEVDVEVEIgogICAgICAgIGZpCiAgICAgICAgOzsKICAgICJQQ1JfVU5QUk9URUNURUQiKQogICAgICAgIGxvZ1N0YXRlICRQUkVWSU9VU19TVEFURSAkQ1VSUkVOVF9TVEFURQogICAgICAgIFBSRVZJT1VTX1NUQVRFPSRDVVJSRU5UX1NUQVRFCiAgICAgICAgaWYgaXNadHBTdGF0ZSAiZG9uZSIgJiYgISBpc1p0cFN0YXRlICJydW5uaW5nIjsgdGhlbgogICAgICAgICAgICByZWJpbmRXaXRoUGNyMUFuZDcKICAgICAgICAgICAgaWYgaXNSZXNlcnZlZFNsb3RQcmVzZW50OyB0aGVuCiAgICAgICAgICAgICAgICByZW1vdmVSZXNlcnZlZFNsb3QKICAgICAgICAgICAgZmkKICAgICAgICAgICAgQ1VSUkVOVF9TVEFURT0iUENSX1BST1RFQ1RFRCIKICAgICAgICBmaQogICAgICAgIDs7CiAgICAqKQogICAgICAgICMgQ29kZSB0byBleGVjdXRlIHdoZW4gbm8gcGF0dGVybnMgbWF0Y2gKICAgICAgICA7OwogICAgZXNhYwoKZG9uZQo="
          verification: {}
        mode: 448
        path: /usr/local/bin/rebind-pcr-1-7.sh
    systemd:
      units:
      - contents: "[Unit]\nAfter=cryptsetup.target\n[Service]\nType=oneshot\nExecStart=/usr/local/bin/rebind-pcr-1-7.sh\n[Install]\nWantedBy=multi-user.target\n"
        enabled: true
        name: rebind-pcr-1-7.service
  
