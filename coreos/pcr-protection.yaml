apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: 99-disk-encryption-master
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
      - contents:
          source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKREVCVUc9dHJ1ZQpSRVNFUlZFRF9TTE9UPTMxCgojIGNyZWF0ZSBhIHRlbXBvcmFyeSBrZXkgaW4gdGhlIHJlc2VydmVkIHNsb3QgdG8gZGlzYWJsZSBQQ1IgcHJvdGVjdGlvbgphZGRSZXNlcnZlZFNsb3QoKSB7CiAgICBBTllQQVNTPSIxMjM0NTY3ODkwIgogICAgZWNobyAtZSAiJEFOWVBBU1NcbiIgfCBjbGV2aXMgbHVrcyBiaW5kIC1zICRSRVNFUlZFRF9TTE9UIC1kIC9kZXYvZGlzay9ieS1wYXJ0bGFiZWwvcm9vdCB0cG0yICd7fScKfQoKI3NldCAteAoKIyBsb2cgZnVuY3Rpb24uIFRha2VzIDIgYXJndW1lbnRzOgojIGxvZyBsZXZlbDogZGVidWcgb3IgaW5mbwojIHN0cmluZyB0byBwcmludApsb2coKSB7CiAgICBjYXNlICQxIGluCiAgICAiZGVidWciKQogICAgICAgIGVjaG8gIkRFQlVHIC0gJDIiCiAgICAgICAgOzsKICAgICJpbmZvIikKICAgICAgICBlY2hvICJJTkZPIC0gJDIiCiAgICAgICAgOzsKICAgICopCiAgICAgICAgIyBDb2RlIHRvIGV4ZWN1dGUgd2hlbiBubyBwYXR0ZXJucyBtYXRjaAogICAgICAgIDs7CiAgICBlc2FjCn0KCiMgbG9ncyBhIHN0cmluZyB3aXRoIGEgZGVidWcgbGV2ZWwKbG9nRGVidWcoKSB7CiAgICBpZiAhIFsgLXYgREVCVUcgXSB8fCAoWyAtdiBERUJVRyBdICYmIFsgIiRERUJVRyIgPT0gInRydWUiIF0pOyB0aGVuCiAgICAgICAgbG9nICJkZWJ1ZyIgIiQxIgogICAgZmkKfQoKIyBsb2dzIGEgc3RyaW5nIHdpdGggYSBpbmZvIGxldmVsCmxvZ0luZm8oKSB7CiAgICBsb2cgImluZm8iICIkMSIKfQoKaXNVcGdyYWRlT3JEb3duZ3JhZGVPbk5leHRSZWJvb3QoKSB7CiAgICBSRVNVTFQ9JChvc3RyZWUgYWRtaW4gc3RhdHVzIHwgZ3JlcCAtRSAic3RhZ2VkfHBlbmRpbmciKQogICAgaWYgWyAiJFJFU1VMVCIgIT0gIiIgXTsgdGhlbgogICAgICAgIHJldHVybiAwCiAgICBlbHNlCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCn0KCmlzRldVcGRhdGVPbk5leHRSZWJvb3QoKSB7CiAgICBFRkk9JChlZmlib290bWdyKQogICAgTkVYVF9CT09UPSQoZWNobyAkRUZJIHwgZ3JlcCAiQm9vdE5leHQ6IiB8IGF3ayB7J3ByaW50ICQyJ30pCiAgICBpZiBbICIkTkVYVF9CT09UIiA9PSAiIiBdOyB0aGVuCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCiAgICBGV1VQRD0kKGVjaG8gJEVGSSB8IGdyZXAgIkJvb3QkTkVYVF9CT09UIiB8IGdyZXAgImZ3dXBkIikKICAgICMgaWYgdGhlIG5leHQgYm9vdCBsaW5lIGNvbnRhaW5zIHRoZSB0ZXh0ICJmd3VwZCIKICAgIGlmIFsgJD8gXTsgdGhlbgogICAgICAgIHJldHVybiAwCiAgICBmaQogICAgcmV0dXJuIDEKfQoKbG9nSW5mbyAiU2h1dHRpbmcgZG93biBvciByZWJvb3RpbmciCgppZiBpc0ZXVXBkYXRlT25OZXh0UmVib290OyB0aGVuCiAgICBsb2dJbmZvICJGVyB1cGRhdGUgZGV0ZWN0ZWQsIGRpc2FibGluZyBQQ1IgcHJvdGVjdGlvbiIKICAgIGFkZFJlc2VydmVkU2xvdAogICAgY2xldmlzIGx1a3MgbGlzdCAtZCAvZGV2L2Rpc2svYnktcGFydGxhYmVsL3Jvb3QKICAgIGV4aXQgMApmaQoKaWYgaXNVcGdyYWRlT3JEb3duZ3JhZGVPbk5leHRSZWJvb3Q7IHRoZW4KICAgIGxvZ0luZm8gIkNvcmVPUyB1cGRhdGUgZGV0ZWN0ZWQsIGRpc2FibGluZyBQQ1IgcHJvdGVjdGlvbiIKICAgIGFkZFJlc2VydmVkU2xvdAogICAgY2xldmlzIGx1a3MgbGlzdCAtZCAvZGV2L2Rpc2svYnktcGFydGxhYmVsL3Jvb3QKICAgIGV4aXQgMApmaQoKbG9nSW5mbyAiTm8gRlcgb3IgT1MgdXBkYXRlIGRldGVjdGVkLCBjb250aW51ZSIK
        mode: 493
        path: /usr/local/bin/disablePcrOnRebootOrShutdown.sh
      - contents:
          source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKREVCVUc9dHJ1ZQpDTEVWSVNfQ09ORklHX1JPT1Q9J3sidCI6MSwicGlucyI6eyJ0cG0yIjpbeyJoYXNoIjoic2hhMjU2Iiwia2V5IjoiZWNjIiwicGNyX2JhbmsiOiJzaGEyNTYiLCJwY3JfaWRzIjoiMSw3In1dfX0nCgpSRVNFUlZFRF9TTE9UPTMxClJPT1RfU0xPVD0xCkNMRVZJU19DT05GSUdfUkVTRVJWRURfU0xPVD0iJFJFU0VSVkVEX1NMT1Q6IHRwbTIgJ3tcImhhc2hcIjpcInNoYTI1NlwiLFwia2V5XCI6XCJlY2NcIn0nIgpDTEVWSVNfQ09ORklHX1JPT1RfU0xPVD0iJFJPT1RfU0xPVDogc3NzICckQ0xFVklTX0NPTkZJR19ST09UJyIKCiMgcmV0dXJuIHRydWUgaWQgdGhlIHRlbXBvcmFyeSByZXNlcnZlZCBzbG90IGlzIGNvbmZpZ3VyZWQgd2l0aCBhIGtleSAodG8gZGlzYWJsZSBQQ1IgcHJvdGVjdGlvbiksIHJldHVybnMgZmFsc2Ugb3RoZXJ3aXNlCmlzUmVzZXJ2ZWRTbG90UHJlc2VudCgpIHsKICAgIFJFU1VMVD0kKGNsZXZpcyBsdWtzIGxpc3QgLWQgL2Rldi9kaXNrL2J5LXBhcnRsYWJlbC9yb290IC1zICRSRVNFUlZFRF9TTE9UKQogICAgaWYgWyAtbiAiJFJFU1VMVCIgXSAmJiBbICIkUkVTVUxUIiA9PSAiJENMRVZJU19DT05GSUdfUkVTRVJWRURfU0xPVCIgXTsgdGhlbgogICAgICAgIGxvZ0RlYnVnICJyZXNlcnZlZCBzbG90ICRSRVNFUlZFRF9TTE9UIGlzIHByZXNlbnQiCiAgICAgICAgcmV0dXJuIDAKICAgIGZpCiAgICBsb2dEZWJ1ZyAicmVzZXJ2ZWQgc2xvdCAkUkVTRVJWRURfU0xPVCBpcyBub3QgcHJlc2VudCIKICAgIHJldHVybiAxCn0KCiMgcmVtb3ZlIHRoZSB0ZW1wb3Jhcnkga2V5IGluIHRoZSByZXNlcnZlZCBzbG90IHRvIGVuYWJsZSBQQ1IgcHJvdGVjdGlvbgpyZW1vdmVSZXNlcnZlZFNsb3QoKSB7CiAgICBjbGV2aXMgbHVrcyB1bmJpbmQgLXMgJFJFU0VSVkVEX1NMT1QgLWQgL2Rldi9kaXNrL2J5LXBhcnRsYWJlbC9yb290IC1mCn0KCiMgcmViaW5kIHRoZSByb290IGRpc2sgd2l0aCBQQ1IgMSBhbmQgNyBwcm90ZWN0aW9uCnJlYmluZFdpdGhQY3IoKSB7CiAgICBjbGV2aXMtbHVrcy1lZGl0IC1kIC9kZXYvZGlzay9ieS1wYXJ0bGFiZWwvcm9vdCAtcyAkUk9PVF9TTE9UIC1jICIkQ0xFVklTX0NPTkZJR19ST09UIgp9CgojIHJldHVybiB0cnVlIGlmIHRoZSByb290IGRpc2sgaXMgYm91bmQgd2l0aCBQQ1IsIGZhbHNlIG90aGVyd2lzZQppc1Jvb3RCb3VuZFRvUGNyKCkgewogICAgUkVTVUxUPSQoY2xldmlzIGx1a3MgbGlzdCAtZCAvZGV2L2Rpc2svYnktcGFydGxhYmVsL3Jvb3QgLXMgJFJPT1RfU0xPVCkKICAgIGlmIFsgIiRSRVNVTFQiID09ICIkQ0xFVklTX0NPTkZJR19ST09UX1NMT1QiIF07IHRoZW4KICAgICAgICBsb2dEZWJ1ZyAicm9vdCBkaXNrIGlzIGVuY3J5cHRlZCBhbmQgYm91bmQgd2l0aCBUUE12MiBQQ1IiCiAgICAgICAgcmV0dXJuIDAKICAgIGZpCiAgICBsb2dEZWJ1ZyAicm9vdCBkaXNrIGlzIG5vdCBib3VuZCB3aXRoIFRQTXYyIFBDUiIKICAgIHJldHVybiAxCn0KCiMgbG9nIGZ1bmN0aW9uLiBUYWtlcyAyIGFyZ3VtZW50czoKIyBsb2cgbGV2ZWw6IGRlYnVnIG9yIGluZm8KIyBzdHJpbmcgdG8gcHJpbnQKbG9nKCkgewogICAgY2FzZSAkMSBpbgogICAgImRlYnVnIikKICAgICAgICBlY2hvICJERUJVRyAtICQyIgogICAgICAgIDs7CiAgICAiaW5mbyIpCiAgICAgICAgZWNobyAiSU5GTyAtICQyIgogICAgICAgIDs7CiAgICAqKQogICAgICAgICMgQ29kZSB0byBleGVjdXRlIHdoZW4gbm8gcGF0dGVybnMgbWF0Y2gKICAgICAgICA7OwogICAgZXNhYwp9CgojIGxvZ3MgYSBzdHJpbmcgd2l0aCBhIGRlYnVnIGxldmVsCmxvZ0RlYnVnKCkgewogICAgaWYgISBbIC12IERFQlVHIF0gfHwgKFsgLXYgREVCVUcgXSAmJiBbICIkREVCVUciID09ICJ0cnVlIiBdKTsgdGhlbgogICAgICAgIGxvZyAiZGVidWciICIkMSIKICAgIGZpCn0KCiMgbG9ncyBhIHN0cmluZyB3aXRoIGEgaW5mbyBsZXZlbApsb2dJbmZvKCkgewogICAgbG9nICJpbmZvIiAiJDEiCn0KCmxvZ0luZm8gImJvb3RpbmcgY2hlY2tpbmcgaWYgcmViaW5kaW5nIGRpc2sgbmVlZGVkIgpjbGV2aXMgbHVrcyBsaXN0IC1kIC9kZXYvZGlzay9ieS1wYXJ0bGFiZWwvcm9vdCAtcyAkUkVTRVJWRURfU0xPVAppZiBpc1Jlc2VydmVkU2xvdFByZXNlbnQ7IHRoZW4KICAgIGxvZ0luZm8gInJlc2VydmVkIHNsb3QgJFJFU0VSVkVEX1NMT1QgZGV0ZWN0ZWQsIHJlbW92aW5nIGFuZCByZWJpbmRpbmcgcm9vdCBkaXNrIgogICAgcmVtb3ZlUmVzZXJ2ZWRTbG90CiAgICByZWJpbmRXaXRoUGNyCiAgICBleGl0IDAKZmkKCmlmICEgaXNSb290Qm91bmRUb1BjcjsgdGhlbgogICAgbG9nSW5mbyAiUENSIGNvbmZpZ3VyYXRpb24gbWlzc2luZyBpbiBjbGV2aXMsIHJlYmluZGluZyB3aXRoIFBDUiIKICAgIHJlYmluZFdpdGhQY3IKICAgIGV4aXQgMApmaQoKbG9nSW5mbyAiUENSIGNvbmZpZ3VyYXRpb24gYWxyZWFkeSBwcmVzZW50IGFuZCByZXNlcnZlZCBzbG90IG5vdCBwcmVzZW50LCBjb250aW51ZSBib290Igo=
        mode: 493
        path: /usr/local/bin/rebindDiskOnBoot.sh
    systemd:
      units:
      - contents: |
          [Unit]
          After=cryptsetup.target
          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/rebindDiskOnBoot.sh
          [Install]
          WantedBy=multi-user.target
        enabled: true
        name: pcr-rebind-boot.service
      - contents: |
          [Unit]
          DefaultDependencies=no
          [Service]
          Type=simple
          ExecStart=/usr/local/bin/disablePcrOnRebootOrShutdown.sh
          [Install]
          WantedBy=shutdown.target reboot.target halt.target
        enabled: true
        name: pcr-disable-shutdown.service
